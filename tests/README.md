# 测试文档

## 测试结构

```
tests/
├── setup.js                    # 测试环境设置
├── helpers/
│   └── testUtils.js           # 测试工具函数
├── models/                     # 模型测试
│   ├── User.test.js           # 用户模型测试
│   ├── Circle.test.js         # 朋友圈模型测试
│   └── Post.test.js           # 帖子模型测试
├── middleware/                 # 中间件测试
│   └── openidAuth.test.js     # OpenID认证测试
├── controllers/                # 控制器测试
│   └── wechatAuth.test.js     # 微信登录测试
├── utils/                      # 工具函数测试
│   └── errorHandler.test.js   # 错误处理测试
├── routes/                     # 路由测试
│   ├── circles.test.js        # 朋友圈路由测试
│   └── posts.test.js          # 帖子路由测试
└── integration/                # 集成测试
    └── wechat.test.js         # 微信API集成测试
```

## 运行测试

### 运行所有测试
```bash
npm test
```

### 运行测试并监听文件变化
```bash
npm run test:watch
```

### 运行测试并生成覆盖率报告
```bash
npm run test:coverage
```

## 测试覆盖范围

### 模型测试 (Models)
- ✅ User 模型验证
- ✅ Circle 模型验证
- ✅ Post 模型验证
- ✅ 实例方法测试
- ✅ 数据关联测试
- ✅ 虚拟字段测试
- ✅ 索引验证测试

### 中间件测试 (Middleware)
- ✅ OpenID 认证中间件
- ✅ 错误处理测试
- ✅ 参数验证测试
- ✅ 多种参数传递方式测试

### 控制器测试 (Controllers)
- ✅ 微信登录控制器
- ✅ 错误处理测试
- ✅ 数据库操作测试
- ✅ 外部API模拟测试

### 工具函数测试 (Utils)
- ✅ 错误处理工具
- ✅ 异步包装器
- ✅ 环境适配测试
- ✅ 错误分类测试

### 路由测试 (Routes)
- ✅ 朋友圈路由测试
  - 创建朋友圈
  - 获取朋友圈列表
  - 加入/退出朋友圈
  - 权限验证
- ✅ 帖子路由测试
  - 发布帖子
  - 获取帖子列表
  - 点赞/取消点赞
  - 删除帖子
  - 评论功能
  - 权限验证

### 集成测试 (Integration)
- ✅ API 端点测试
- ✅ 完整流程测试
- ✅ 错误场景测试
- ✅ 微信登录流程测试

## 测试特点

### 1. 内存数据库
- 使用 `mongodb-memory-server` 进行测试
- 每个测试后自动清理数据
- 不影响生产数据库

### 2. 模拟外部服务
- 模拟微信 API 调用
- 模拟网络错误
- 模拟数据库错误

### 3. 完整的错误测试
- 验证错误处理机制
- 测试边界条件
- 确保错误信息正确

### 4. 测试工具函数
- 提供测试数据生成
- 模拟请求和响应对象
- 简化测试代码编写

### 5. 全面的路由测试
- 测试所有API端点
- 验证请求参数验证
- 测试权限控制
- 验证响应格式

## 测试最佳实践

### 1. 测试命名
- 使用描述性的测试名称
- 遵循 "should" 模式
- 清晰表达测试意图

### 2. 测试组织
- 按功能模块分组
- 使用 describe 块组织相关测试
- 保持测试结构清晰

### 3. 测试数据
- 使用独立的测试数据
- 避免测试间数据依赖
- 使用工具函数生成测试数据

### 4. 错误测试
- 测试所有错误场景
- 验证错误响应格式
- 确保错误处理正确

### 5. 权限测试
- 测试认证失败场景
- 验证权限控制
- 测试越权访问

## 覆盖率目标

- **语句覆盖率**: > 90%
- **分支覆盖率**: > 85%
- **函数覆盖率**: > 95%
- **行覆盖率**: > 90%

## 测试统计

### 模型测试
- **User**: 8个测试用例
- **Circle**: 12个测试用例
- **Post**: 15个测试用例

### 中间件测试
- **openidAuth**: 8个测试用例

### 控制器测试
- **wechatAuth**: 8个测试用例

### 工具函数测试
- **errorHandler**: 12个测试用例

### 路由测试
- **circles**: 15个测试用例
- **posts**: 25个测试用例

### 集成测试
- **wechat**: 8个测试用例

**总计**: 约100个测试用例

## 持续集成

测试配置支持 CI/CD 环境：
- 自动运行所有测试
- 生成覆盖率报告
- 失败时阻止部署
- 支持并行测试执行 